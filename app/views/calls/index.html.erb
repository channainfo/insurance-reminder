<%= page_title "Call list" %>

<div class='panel panel-default'>
  <div class='panel-heading'> 
    <h3 class='panel-title'>Filter</h3>
  </div>

  <div class="panel-body" style='padding: 10px 0px;'>
    <%= form_tag '/search', method: 'GET' do |f| %>
      
      <div class='input-row col-lg-2'>
        <%= label_tag :family_code %>
        <%= text_field_tag :family_code, params[:family_code], class: 'form-control' %>
      </div>

      <div class='input-row col-lg-2'>
        <%= label_tag :phone_number %>
        <%= text_field_tag :phone_number, params[:phone_number], class: 'form-control' %>
      </div>

      <div class='input-row col-lg-2'>
        <%= label_tag :expiration_date_start %>
        <%= text_field_tag :expiration_date_start, params[:expiration_date_start], class: 'form-control date-picker' %>
      </div>

      <div class='input-row col-lg-2'>
        <%= label_tag :expiration_date_end %>
        <%= text_field_tag :expiration_date_end, params[:expiration_date_end], class: 'form-control date-picker' %>
      </div>

      <div class='input-row col-lg-2'>
        <%= label_tag :status, 'Call Status' %>
        
        <select id="status" name="status[]" class="form-control" multiple="multiple">
          <% Call::STATUSES.each do |status| %>
            <option value="<%=status%>" <%= (params[:status].present? and params[:status].include?(status))? "selected" : ""%>><%=status%></option>
          <% end %>
        </select>
      </div>

      <div class='input-row col-lg-2' style="text-align:right;">
        <button class='btn btn-primary' style='margin-top: 25px;'>
          <i class='glyphicon glyphicon-search'> </i> Search
        </button>
      </div>
    <% end %>
  </div>
</div>

<% Call::STATUSES.each do |status| %>
  <% if @data_by_status[status].present? %>
    <div class="progress">
      <div class="progress-bar" role="progressbar" aria-valuenow="<%= @data_by_status[status] * 100 / @calls.total_count %>" aria-valuemin="0" aria-valuemax="100" style="width: <%= @data_by_status[status] * 100 / @calls.total_count %>%;">
          <span class="sr-only"><%= @data_by_status[status] * 100 / @calls.total_count %>% Complete</span>
      </div>
      <span class="progress-type"><%= status + " (#{@data_by_status[status]})" %></span>
      <span class="progress-completed"><%= @data_by_status[status] * 100 / @calls.total_count %>%</span>
    </div>
  <% else %>
    <div class="progress">
      <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
          <span class="sr-only">0</span>
      </div>
      <span class="progress-type"><%= status %></span>
      <span class="progress-completed">0%</span>
    </div>
  <% end %>
<% end %>

<div class='clearfix' style="padding-bottom: 10px;">
  <div class='pull-left'>
    <%= paginate @calls, theme: 'twitter-bootstrap-3' %>
  </div>
  <div class='pull-right' style='margin-top: 15px;'>
    <%= link_to download_csv_calls_path(app_params), class: 'btn btn- btn-primary' do %>
      <i class='glyphicon glyphicon-download-alt'> </i> Download CSV
    <% end %>
    <button class='btn btn-primary' data-toggle="modal" data-target="#new-reminder">
      <i class='glyphicon glyphicon-plus'> </i> Add Reminder
    </button>
  </div>
</div>

<%= render 'new' %>

<table class='table table-strip table-hover'>
  <thead>
    <tr>
      <td></td>
      <td>Family code</td>
      <td>Full name</td>
      <td>Call status</td>
      <td>Recalls</td>
      <td>Expiration date</td>
      <td>Phone number</td>
      <td width="120">Reminder date</td>
      <td>Type</td>
      <td>Called at</td>
      <td> Action </td>
    </tr>
  </thead>

  <tbody>
    <% @calls.each_with_index do |call, index| %>
      <tr>
        <td>
          <input type="checkbox" class="checkDisabled" value="<%= call.id %>">
        </td>
        <td><%= call.family_code %></td>
        <td><%= call.full_name %></td>
        <td><%= call.status %></td>
        <td>
          <% if call.calls_count > 0 %>
            <%= render 'retries', call: call %>
            <%= link_to call.calls_count, "#retries-call-#{call.id}", 'data-toggle': "modal", class: 'badge' %>
          <% else %>
          <% end %>
        </td>
        <td><%= call.expiration_date %></td>
        <td><%= call.phone_number %></td>
        <td><%= call.created_at.to_date %></td>
        <td><%= call.kind_text %></td>
        <td><%= timeago_tag(call.updated_at)%></td>
        <td>
          <% if call.retryable? %>
            <%= link_to 'Recall', retry_call_path(call), method: 'PUT', class: 'btn btn-sm btn-primary' %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
<div class='clearfix' style="padding-bottom: 10px;">
  <div class='pull-right'>
    <button class='btn btn-danger' onclick="disableCall()">
      <i class='glyphicon glyphicon-remove'> </i> Mark as Disabled
    </button>
  </div>
</div>
<div>
  <span class="badge" style="padding:5px;margin-right:5px;">Display record : <%= @calls.size %> / <%= @calls.total_count %>
  </span>
</div>
<%= paginate @calls, theme: 'twitter-bootstrap-3' %>
<script type="text/javascript">
$("#status").multiselect();
</script>